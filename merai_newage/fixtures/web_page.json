[
 {
  "breadcrumbs": null,
  "content_type": "HTML",
  "context_script": null,
  "css": null,
  "docstatus": 0,
  "doctype": "Web Page",
  "dynamic_route": 0,
  "dynamic_template": 0,
  "enable_comments": 0,
  "end_date": null,
  "full_width": 1,
  "header": null,
  "insert_style": 0,
  "javascript": null,
  "main_section": null,
  "main_section_html": "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Ticket Master Dashboard</title>\n    <style>\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n            background-color: #f5f7fa;\n            color: #36414c;\n            padding: 20px;\n        }\n\n        /* Hide Frappe header and footer */\n        .navbar, \n        .navbar-default,\n        header,\n        footer,\n        .page-head,\n        .page-actions,\n        .page-breadcrumb,\n        .layout-side-section,\n        .page-form,\n        .page-wrapper > .page-head,\n        .layout-main-section-wrapper > .page-head {\n            display: none !important;\n        }\n\n        .dashboard-header {\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            color: white;\n            padding: 15px 25px;\n            border-radius: 8px;\n            margin-bottom: 20px;\n            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n        }\n\n        .dashboard-header h1 {\n            font-size: 24px;\n            font-weight: 600;\n            margin-bottom: 5px;\n        }\n\n        .dashboard-header p {\n            font-size: 13px;\n            opacity: 0.9;\n        }\n\n        .filters-section {\n            background: white;\n            padding: 15px 20px;\n            border-radius: 8px;\n            margin-bottom: 20px;\n            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);\n            transition: all 0.3s ease;\n        }\n\n        .filters-section.collapsed {\n            padding: 10px 20px;\n        }\n\n        .filters-section.collapsed .filter-content {\n            display: none;\n        }\n\n        .filter-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            cursor: pointer;\n            user-select: none;\n        }\n\n        .filter-header h3 {\n            font-size: 15px;\n            font-weight: 600;\n            margin: 0;\n            color: #36414c;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n        }\n\n        .collapse-icon {\n            font-size: 18px;\n            transition: transform 0.3s ease;\n        }\n\n        .filters-section.collapsed .collapse-icon {\n            transform: rotate(-90deg);\n        }\n\n        .filter-content {\n            margin-top: 15px;\n        }\n\n        .filter-group {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n            gap: 15px;\n            margin-bottom: 15px;\n        }\n\n        .filter-item {\n            display: flex;\n            flex-direction: column;\n        }\n\n        .filter-item label {\n            font-size: 13px;\n            font-weight: 500;\n            color: #6c757d;\n            margin-bottom: 5px;\n        }\n\n        .filter-item select,\n        .filter-item input {\n            padding: 8px 12px;\n            border: 1px solid #d1d8dd;\n            border-radius: 6px;\n            font-size: 14px;\n            background: white;\n            transition: border-color 0.2s;\n        }\n\n        .filter-item select:focus,\n        .filter-item input:focus {\n            outline: none;\n            border-color: #667eea;\n        }\n\n        .filter-actions {\n            display: flex;\n            gap: 10px;\n            margin-top: 15px;\n        }\n\n        .btn {\n            padding: 10px 20px;\n            border: none;\n            border-radius: 6px;\n            font-size: 14px;\n            font-weight: 500;\n            cursor: pointer;\n            transition: all 0.2s;\n        }\n\n        .btn-primary {\n            background: #667eea;\n            color: white;\n        }\n\n        .btn-primary:hover {\n            background: #5568d3;\n        }\n\n        .btn-secondary {\n            background: #f8f9fa;\n            color: #36414c;\n            border: 1px solid #d1d8dd;\n        }\n\n        .btn-secondary:hover {\n            background: #e9ecef;\n        }\n\n        .loading {\n            text-align: center;\n            padding: 20px;\n            font-size: 16px;\n            color: #6c757d;\n        }\n\n        .metrics-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n            gap: 20px;\n            margin-bottom: 30px;\n        }\n\n        .metric-card {\n            background: white;\n            padding: 25px;\n            border-radius: 12px;\n            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);\n            border-left: 4px solid #667eea;\n            transition: transform 0.2s, box-shadow 0.2s;\n            cursor: pointer;\n        }\n\n        .metric-card:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);\n        }\n\n        .metric-card.resolved { border-left-color: #28a745; }\n        .metric-card.pending { border-left-color: #ffc107; }\n        .metric-card.issue { border-left-color: #dc3545; }\n        .metric-card.total { border-left-color: #667eea; }\n\n        .metric-label {\n            font-size: 14px;\n            font-weight: 500;\n            color: #6c757d;\n            margin-bottom: 10px;\n            text-transform: uppercase;\n            letter-spacing: 0.5px;\n        }\n\n        .metric-value {\n            font-size: 36px;\n            font-weight: 700;\n            color: #36414c;\n            margin-bottom: 8px;\n        }\n\n        .metric-change {\n            font-size: 13px;\n            color: #28a745;\n            font-weight: 500;\n        }\n\n        .charts-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));\n            gap: 25px;\n            margin-bottom: 30px;\n        }\n\n        .chart-card {\n            background: white;\n            padding: 25px;\n            border-radius: 12px;\n            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);\n        }\n\n        .chart-card h3 {\n            font-size: 18px;\n            font-weight: 600;\n            margin-bottom: 20px;\n            color: #36414c;\n        }\n\n        .chart-container {\n            min-height: 300px;\n            position: relative;\n        }\n\n        .chart-with-scroll {\n            max-height: 400px;\n            overflow-y: auto;\n            overflow-x: hidden;\n        }\n\n        .pagination-controls {\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            gap: 10px;\n            margin-top: 15px;\n            padding-top: 15px;\n            border-top: 1px solid #e9ecef;\n        }\n\n        .pagination-btn {\n            padding: 8px 16px;\n            border: 1px solid #d1d8dd;\n            border-radius: 6px;\n            background: white;\n            color: #36414c;\n            cursor: pointer;\n            font-size: 13px;\n            font-weight: 500;\n            transition: all 0.2s;\n            display: flex;\n            align-items: center;\n            gap: 5px;\n        }\n\n        .pagination-btn:hover:not(:disabled) {\n            background: #667eea;\n            color: white;\n            border-color: #667eea;\n        }\n\n        .pagination-btn:disabled {\n            opacity: 0.4;\n            cursor: not-allowed;\n            background: #f8f9fa;\n        }\n\n        .pagination-info {\n            font-size: 13px;\n            color: #6c757d;\n            font-weight: 500;\n            padding: 0 10px;\n            min-width: 120px;\n            text-align: center;\n        }\n\n        .pagination-jump {\n            display: flex;\n            align-items: center;\n            gap: 5px;\n        }\n\n        .pagination-jump input {\n            width: 50px;\n            padding: 6px 8px;\n            border: 1px solid #d1d8dd;\n            border-radius: 4px;\n            font-size: 13px;\n            text-align: center;\n        }\n\n        .pagination-jump button {\n            padding: 6px 12px;\n            border: 1px solid #d1d8dd;\n            border-radius: 4px;\n            background: white;\n            color: #36414c;\n            cursor: pointer;\n            font-size: 12px;\n            transition: all 0.2s;\n        }\n\n        .pagination-jump button:hover {\n            background: #667eea;\n            color: white;\n            border-color: #667eea;\n        }\n\n        .table-section {\n            background: white;\n            padding: 25px;\n            border-radius: 12px;\n            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);\n            overflow-x: auto;\n        }\n\n        .table-section h3 {\n            font-size: 18px;\n            font-weight: 600;\n            margin-bottom: 20px;\n            color: #36414c;\n        }\n\n        table {\n            width: 100%;\n            border-collapse: collapse;\n            min-width: 1100px;\n        }\n\n        thead {\n            background-color: #f8f9fa;\n        }\n\n        th {\n            padding: 12px;\n            text-align: left;\n            font-size: 13px;\n            font-weight: 600;\n            color: #6c757d;\n            text-transform: uppercase;\n            letter-spacing: 0.5px;\n            border-bottom: 2px solid #e9ecef;\n        }\n\n        td {\n            padding: 12px;\n            font-size: 14px;\n            border-bottom: 1px solid #e9ecef;\n        }\n\n        tbody tr:hover {\n            background-color: #f8f9fa;\n        }\n\n        .status-badge {\n            display: inline-block;\n            padding: 4px 12px;\n            border-radius: 20px;\n            font-size: 12px;\n            font-weight: 500;\n        }\n\n        .status-resolved {\n            background-color: #d4edda;\n            color: #155724;\n        }\n\n        .status-pending {\n            background-color: #fff3cd;\n            color: #856404;\n        }\n\n        .status-open {\n            background-color: #cce5ff;\n            color: #004085;\n        }\n\n        .status-closed {\n            background-color: #d6d8db;\n            color: #383d41;\n        }\n\n        .ticket-link {\n            color: #667eea;\n            text-decoration: none;\n            font-weight: 500;\n        }\n\n        .ticket-link:hover {\n            text-decoration: underline;\n        }\n\n        .refresh-info {\n            font-size: 12px;\n            color: #6c757d;\n            margin-top: 10px;\n            text-align: right;\n        }\n\n        .error-message {\n            background-color: #f8d7da;\n            color: #721c24;\n            padding: 15px;\n            border-radius: 6px;\n            margin-bottom: 20px;\n            border: 1px solid #f5c6cb;\n        }\n\n        /* Custom scrollbar */\n        .chart-with-scroll::-webkit-scrollbar {\n            width: 8px;\n        }\n\n        .chart-with-scroll::-webkit-scrollbar-track {\n            background: #f1f1f1;\n            border-radius: 4px;\n        }\n\n        .chart-with-scroll::-webkit-scrollbar-thumb {\n            background: #888;\n            border-radius: 4px;\n        }\n\n        .chart-with-scroll::-webkit-scrollbar-thumb:hover {\n            background: #555;\n        }\n\n        @media (max-width: 768px) {\n            .metrics-grid,\n            .charts-grid {\n                grid-template-columns: 1fr;\n            }\n\n            .filter-group {\n                grid-template-columns: 1fr;\n            }\n\n            .charts-grid {\n                grid-template-columns: 1fr;\n            }\n\n            .pagination-controls {\n                flex-wrap: wrap;\n            }\n        }\n    </style>\n</head>\n<body>\n    <div class=\"dashboard-header\">\n        <h1>üé´ Ticket Master Dashboard</h1>\n        <p>Real-time ticket management and analytics</p>\n    </div>\n\n    <div id=\"errorContainer\"></div>\n\n    <div id=\"initialMessage\" class=\"filters-section\" style=\"text-align: center; padding: 20px;\">\n        <h3 style=\"margin-bottom: 8px; font-size: 15px;\">üìÖ Select Date Range to View Dashboard</h3>\n        <p style=\"color: #6c757d; font-size: 13px;\">Please select From Date and To Date, then click \"Apply Filters\" to load the dashboard data.</p>\n    </div>\n\n    <div class=\"filters-section\" id=\"filterSection\">\n        <div class=\"filter-header\" onclick=\"toggleFilters()\">\n            <h3>\n                <span>üìä Filters</span>\n            </h3>\n            <span class=\"collapse-icon\">‚ñº</span>\n        </div>\n        <div class=\"filter-content\">\n            <div class=\"filter-group\">\n                <div class=\"filter-item\">\n                    <label>From Date *</label>\n                    <input type=\"date\" id=\"fromDate\">\n                </div>\n                <div class=\"filter-item\">\n                    <label>To Date *</label>\n                    <input type=\"date\" id=\"toDate\">\n                </div>\n                <div class=\"filter-item\">\n                    <label>State</label>\n                    <select id=\"stateFilter\">\n                        <option value=\"\">Select State</option>\n                    </select>\n                </div>\n                <div class=\"filter-item\">\n                    <label>Hospital Name</label>\n                    <select id=\"hospitalFilter\">\n                        <option value=\"\">Select Hospital</option>\n                    </select>\n                </div>\n                <div class=\"filter-item\">\n                    <label>Robot Serial No</label>\n                    <select id=\"robotFilter\">\n                        <option value=\"\">Select Robot</option>\n                    </select>\n                </div>\n                <div class=\"filter-item\">\n                    <label>Status</label>\n                    <select id=\"statusFilter\">\n                        <option value=\"\">Select Status</option>\n                    </select>\n                </div>\n                <div class=\"filter-item\">\n                    <label>Priority</label>\n                    <select id=\"priorityFilter\">\n                        <option value=\"\">Select Priority</option>\n                    </select>\n                </div>\n                <div class=\"filter-item\">\n                    <label>Issue Type</label>\n                    <select id=\"issueTypeFilter\">\n                        <option value=\"\">Select Type</option>\n                    </select>\n                </div>\n            </div>\n            <div class=\"filter-actions\">\n                <button class=\"btn btn-primary\" onclick=\"applyFilters()\">Apply Filters</button>\n                <button class=\"btn btn-secondary\" onclick=\"clearFilters()\">Clear Filters</button>\n                <button class=\"btn btn-secondary\" onclick=\"refreshData()\">üîÑ Refresh</button>\n            </div>\n        </div>\n    </div>\n\n    <div id=\"loadingIndicator\" class=\"loading\" style=\"display: none;\">\n        Loading dashboard data...\n    </div>\n\n    <div id=\"dashboardContent\" style=\"display: none;\">\n        <div class=\"metrics-grid\">\n            <div class=\"metric-card total\" onclick=\"navigateToDoctypeWithFilters('ticket-master', {})\">\n                <div class=\"metric-label\">Total Tickets</div>\n                <div class=\"metric-value\" id=\"totalTickets\">0</div>\n                <div class=\"metric-change\" id=\"weekCount\">+0 this week</div>\n            </div>\n            <div class=\"metric-card resolved\" onclick=\"navigateToDoctypeWithFilters('ticket-master', {workflow_state: 'Resolved'})\">\n                <div class=\"metric-label\">Resolved</div>\n                <div class=\"metric-value\" id=\"resolvedTickets\">0</div>\n                <div class=\"metric-change\" id=\"resolvedPercent\">0% of total</div>\n            </div>\n            <div class=\"metric-card pending\" onclick=\"navigateToDoctypeWithFilters('ticket-master', {workflow_state_not: 'Resolved'})\">\n                <div class=\"metric-label\">Pending</div>\n                <div class=\"metric-value\" id=\"pendingTickets\">0</div>\n                <div class=\"metric-change\" id=\"pendingPercent\">0% of total</div>\n            </div>\n            <div class=\"metric-card\" style=\"border-left-color: #6c757d;\" onclick=\"navigateToDoctypeWithFilters('ticket-master', {workflow_state: 'Cancelled'})\">\n                <div class=\"metric-label\">Cancelled</div>\n                <div class=\"metric-value\" id=\"cancelledTickets\">0</div>\n                <div class=\"metric-change\" id=\"cancelledPercent\">0% of total</div>\n            </div>\n            <div class=\"metric-card issue\">\n                <div class=\"metric-label\">Avg Resolution Time</div>\n                <div class=\"metric-value\" style=\"font-size: 28px;\" id=\"avgTime\">0 days</div>\n                <div class=\"metric-change\">Average time to resolve</div>\n            </div>\n        </div>\n\n        <div class=\"charts-grid\">\n            <div class=\"chart-card\">\n                <h3>üìà Ticket Status Distribution</h3>\n                <div class=\"chart-container\">\n                    <canvas id=\"statusChart\"></canvas>\n                </div>\n            </div>\n            <div class=\"chart-card\">\n                <h3>üìä Tickets by Issue Type</h3>\n                <div class=\"chart-container\">\n                    <canvas id=\"issueTypeChart\"></canvas>\n                </div>\n            </div>\n            <div class=\"chart-card\">\n                <h3>üìÖ Tickets Over Time</h3>\n                <div class=\"chart-container\" style=\"cursor: default;\">\n                    <canvas id=\"timelineChart\"></canvas>\n                </div>\n                <div class=\"pagination-controls\" id=\"timelinePagination\" style=\"display: none;\">\n                    <button class=\"pagination-btn\" onclick=\"changeTimelinePage(-1)\" id=\"timelinePrevBtn\">\n                        ‚Üê Previous\n                    </button>\n                    <span class=\"pagination-info\" id=\"timelinePageInfo\">Page 1 of 1</span>\n                    <div class=\"pagination-jump\">\n                        <span style=\"font-size: 12px; color: #6c757d;\">Go to:</span>\n                        <input type=\"number\" id=\"timelinePageInput\" min=\"1\" value=\"1\">\n                        <button onclick=\"jumpToTimelinePage()\">Go</button>\n                    </div>\n                    <button class=\"pagination-btn\" onclick=\"changeTimelinePage(1)\" id=\"timelineNextBtn\">\n                        Next ‚Üí\n                    </button>\n                </div>\n            </div>\n            <div class=\"chart-card\">\n                <h3>üè• Top Hospitals by Tickets</h3>\n                <div class=\"chart-with-scroll\" id=\"hospitalChartContainer\">\n                    <canvas id=\"hospitalChart\"></canvas>\n                </div>\n                <div class=\"pagination-controls\" id=\"hospitalPagination\" style=\"display: none;\">\n                    <button class=\"pagination-btn\" onclick=\"changeHospitalPage(-1)\" id=\"hospitalPrevBtn\">\n                        ‚Üê Previous\n                    </button>\n                    <span class=\"pagination-info\" id=\"hospitalPageInfo\">Page 1 of 1</span>\n                    <div class=\"pagination-jump\">\n                        <span style=\"font-size: 12px; color: #6c757d;\">Go to:</span>\n                        <input type=\"number\" id=\"hospitalPageInput\" min=\"1\" value=\"1\">\n                        <button onclick=\"jumpToHospitalPage()\">Go</button>\n                    </div>\n                    <button class=\"pagination-btn\" onclick=\"changeHospitalPage(1)\" id=\"hospitalNextBtn\">\n                        Next ‚Üí\n                    </button>\n                </div>\n            </div>\n        </div>\n\n        <div class=\"charts-grid\">\n            <div class=\"chart-card\">\n                <h3>üìç Tickets by State</h3>\n                <div class=\"chart-with-scroll\" id=\"stateChartContainer\">\n                    <canvas id=\"stateChart\"></canvas>\n                </div>\n                <div class=\"pagination-controls\" id=\"statePagination\" style=\"display: none;\">\n                    <button class=\"pagination-btn\" onclick=\"changeStatePage(-1)\" id=\"statePrevBtn\">\n                        ‚Üê Previous\n                    </button>\n                    <span class=\"pagination-info\" id=\"statePageInfo\">Page 1 of 1</span>\n                    <div class=\"pagination-jump\">\n                        <span style=\"font-size: 12px; color: #6c757d;\">Go to:</span>\n                        <input type=\"number\" id=\"statePageInput\" min=\"1\" value=\"1\">\n                        <button onclick=\"jumpToStatePage()\">Go</button>\n                    </div>\n                    <button class=\"pagination-btn\" onclick=\"changeStatePage(1)\" id=\"stateNextBtn\">\n                        Next ‚Üí\n                    </button>\n                </div>\n            </div>\n            <div class=\"chart-card\">\n                <h3>‚ö†Ô∏è Priority Distribution</h3>\n                <div class=\"chart-container\">\n                    <canvas id=\"priorityChart\"></canvas>\n                </div>\n            </div>\n            <div class=\"chart-card\">\n                <h3>ü§ñ Robots with Most Issues</h3>\n                <div class=\"chart-with-scroll\" id=\"robotChartContainer\">\n                    <canvas id=\"robotChart\"></canvas>\n                </div>\n                <div class=\"pagination-controls\" id=\"robotPagination\" style=\"display: none;\">\n                    <button class=\"pagination-btn\" onclick=\"changeRobotPage(-1)\" id=\"robotPrevBtn\">\n                        ‚Üê Previous\n                    </button>\n                    <span class=\"pagination-info\" id=\"robotPageInfo\">Page 1 of 1</span>\n                    <div class=\"pagination-jump\">\n                        <span style=\"font-size: 12px; color: #6c757d;\">Go to:</span>\n                        <input type=\"number\" id=\"robotPageInput\" min=\"1\" value=\"1\">\n                        <button onclick=\"jumpToRobotPage()\">Go</button>\n                    </div>\n                    <button class=\"pagination-btn\" onclick=\"changeRobotPage(1)\" id=\"robotNextBtn\">\n                        Next ‚Üí\n                    </button>\n                </div>\n            </div>\n        </div>\n\n        <div class=\"table-section\">\n            <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;\">\n                <h3>üìã Recent Tickets</h3>\n                <button class=\"btn btn-primary\" onclick=\"exportToCSV()\">Export to CSV</button>\n            </div>\n            <table>\n                <thead>\n                    <tr>\n                        <th>Ticket ID</th>\n                        <th>Status</th>\n                        <th>State</th>\n                        <th>Robot Serial No</th>\n                        <th>Ticket Subject</th>\n                        <th>Hospital</th>\n                        <th>Issue Type</th>\n                        <th>Priority</th>\n                        <th>Engineers</th>\n                        <th>Days Open</th>\n                        <th>Created On</th>\n                    </tr>\n                </thead>\n                <tbody id=\"ticketTable\">\n                    <!-- Data will be populated dynamically -->\n                </tbody>\n            </table>\n            <div class=\"refresh-info\">Last updated: <span id=\"lastUpdate\"></span></div>\n        </div>\n    </div>\n\n    <script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>\n    <script>\n        // CRITICAL FIX: Hide Frappe UI elements on page load\n        document.addEventListener('DOMContentLoaded', function() {\n            console.log('Dashboard initialized - waiting for user to select dates');\n            \n            // Hide Frappe header and footer elements\n            setTimeout(function() {\n                const elementsToHide = document.querySelectorAll(\n                    '.navbar, .navbar-default, header, footer, .page-head, ' +\n                    '.page-actions, .page-breadcrumb, .layout-side-section, ' +\n                    '.page-form, .page-wrapper > .page-head, ' +\n                    '.layout-main-section-wrapper > .page-head, ' +\n                    '.page-title, .page-toolbar, .standard-actions, ' +\n                    '.page-icon, .page-wrapper-background'\n                );\n                \n                elementsToHide.forEach(el => {\n                    if (el) el.style.display = 'none';\n                });\n            }, 100);\n        });\n\n        // Toggle filter section collapse\n        function toggleFilters() {\n            const filterSection = document.getElementById('filterSection');\n            filterSection.classList.toggle('collapsed');\n        }\n\n        // Global variables\n        let dashboardData = null;\n        let charts = {};\n        \n        // Pagination variables\n        const ITEMS_PER_PAGE = 10;\n        const SCROLL_THRESHOLD = 15;\n        \n        let currentPages = {\n            timeline: 0,\n            hospital: 0,\n            state: 0,\n            robot: 0\n        };\n        \n        let fullData = {\n            timeline: { labels: [], data: [] },\n            hospital: { labels: [], data: [] },\n            state: { labels: [], data: [] },\n            robot: { labels: [], data: [] }\n        };\n\n        async function loadFilterOptions() {\n            const fromDate = document.getElementById('fromDate').value;\n            const toDate = document.getElementById('toDate').value;\n            \n            if (!fromDate || !toDate) {\n                return;\n            }\n            \n            try {\n                const [states, hospitals, robots, statuses, priorities, issueTypes] = await Promise.all([\n                    fetchFilterOptions('state', fromDate, toDate),\n                    fetchFilterOptions('hospital', fromDate, toDate),\n                    fetchFilterOptions('robot', fromDate, toDate),\n                    fetchFilterOptions('status', fromDate, toDate),\n                    fetchFilterOptions('priority', fromDate, toDate),\n                    fetchFilterOptions('issue_type', fromDate, toDate)\n                ]);\n                \n                populateSelect('stateFilter', states);\n                populateSelect('hospitalFilter', hospitals);\n                populateSelect('robotFilter', robots);\n                populateSelect('statusFilter', statuses);\n                populateSelect('priorityFilter', priorities);\n                populateSelect('issueTypeFilter', issueTypes);\n            } catch (error) {\n                console.error('Error loading filter options:', error);\n                showError('Failed to load filter options: ' + error.message);\n            }\n        }\n\n        async function fetchFilterOptions(filterType, fromDate, toDate) {\n            try {\n                const response = await fetch('/api/method/merai_newage.merai_newage.utils.dashboard_api.get_filter_options', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'X-Frappe-CSRF-Token': frappe.csrf_token\n                    },\n                    body: JSON.stringify({\n                        filter_type: filterType,\n                        from_date: fromDate,\n                        to_date: toDate\n                    })\n                });\n                \n                const result = await response.json();\n                \n                if (!response.ok) {\n                    console.error(`Error fetching ${filterType} options:`, result);\n                    return [];\n                }\n                \n                return result.message || [];\n            } catch (error) {\n                console.error(`Error fetching ${filterType} options:`, error);\n                return [];\n            }\n        }\n\n        function populateSelect(selectId, options) {\n            const select = document.getElementById(selectId);\n            const currentValue = select.value;\n            \n            const firstOption = select.options[0];\n            select.innerHTML = '';\n            select.appendChild(firstOption);\n            \n            options.forEach(option => {\n                const opt = document.createElement('option');\n                opt.value = option;\n                opt.textContent = option;\n                select.appendChild(opt);\n            });\n            \n            if (currentValue && options.includes(currentValue)) {\n                select.value = currentValue;\n            }\n        }\n\n        async function loadDashboardData() {\n            showLoading(true);\n            hideError();\n            \n            try {\n                const filters = getFilters();\n                \n                console.log('Loading dashboard with filters:', filters);\n                \n                const response = await fetch('/api/method/merai_newage.merai_newage.utils.dashboard_api.get_dashboard_data', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'X-Frappe-CSRF-Token': frappe.csrf_token\n                    },\n                    body: JSON.stringify({ filters: filters })\n                });\n                \n                if (!response.ok) {\n                    throw new Error(`HTTP error! status: ${response.status}`);\n                }\n                \n                const result = await response.json();\n                console.log('Dashboard data received:', result);\n                \n                if (result.message) {\n                    dashboardData = result.message;\n                    renderDashboard();\n                } else {\n                    throw new Error('No data received from server');\n                }\n            } catch (error) {\n                console.error('Error loading dashboard data:', error);\n                showError('Failed to load dashboard data: ' + error.message + '. Please check your connection and try again.');\n            } finally {\n                showLoading(false);\n            }\n        }\n\n        function getFilters() {\n            return {\n                from_date: document.getElementById('fromDate').value || null,\n                to_date: document.getElementById('toDate').value || null,\n                state: document.getElementById('stateFilter').value || null,\n                hospital_name: document.getElementById('hospitalFilter').value || null,\n                robot_serial_no: document.getElementById('robotFilter').value || null,\n                status: document.getElementById('statusFilter').value || null,\n                priorty: document.getElementById('priorityFilter').value || null,\n                issue_type: document.getElementById('issueTypeFilter').value || null\n            };\n        }\n\n        function renderDashboard() {\n            const initialMsg = document.getElementById('initialMessage');\n            if (initialMsg) {\n                initialMsg.style.display = 'none';\n            }\n            \n            updateMetrics();\n            renderCharts();\n            populateTable();\n            updateTimestamp();\n            document.getElementById('dashboardContent').style.display = 'block';\n        }\n\n        function updateMetrics() {\n            const metrics = dashboardData.metrics;\n            \n            document.getElementById('totalTickets').textContent = metrics.total;\n            document.getElementById('resolvedTickets').textContent = metrics.resolved;\n            document.getElementById('pendingTickets').textContent = metrics.pending;\n            document.getElementById('cancelledTickets').textContent = metrics.cancelled;\n            document.getElementById('avgTime').textContent = metrics.avg_resolution_time + ' days';\n            \n            document.getElementById('weekCount').textContent = `+${metrics.week_count} this week`;\n            document.getElementById('resolvedPercent').textContent = `${metrics.resolved_percentage}% of total`;\n            document.getElementById('pendingPercent').textContent = `${metrics.pending_percentage}% of total`;\n            document.getElementById('cancelledPercent').textContent = `${metrics.cancelled_percentage}% of total`;\n        }\n\n        function getPaginatedData(labels, data, page, itemsPerPage) {\n            const startIndex = page * itemsPerPage;\n            const endIndex = startIndex + itemsPerPage;\n            return {\n                labels: labels.slice(startIndex, endIndex),\n                data: data.slice(startIndex, endIndex)\n            };\n        }\n\n        function updatePaginationControls(chartType, currentPage, totalPages) {\n            const paginationDiv = document.getElementById(`${chartType}Pagination`);\n            const pageInfo = document.getElementById(`${chartType}PageInfo`);\n            const prevBtn = document.getElementById(`${chartType}PrevBtn`);\n            const nextBtn = document.getElementById(`${chartType}NextBtn`);\n            const pageInput = document.getElementById(`${chartType}PageInput`);\n            \n            if (totalPages > 1) {\n                paginationDiv.style.display = 'flex';\n                pageInfo.textContent = `Page ${currentPage + 1} of ${totalPages}`;\n                prevBtn.disabled = currentPage === 0;\n                nextBtn.disabled = currentPage === totalPages - 1;\n                \n                if (pageInput) {\n                    pageInput.value = currentPage + 1;\n                    pageInput.max = totalPages;\n                }\n            } else {\n                paginationDiv.style.display = 'none';\n            }\n        }\n\n        function changeTimelinePage(direction) {\n            const totalPages = Math.ceil(fullData.timeline.labels.length / ITEMS_PER_PAGE);\n            currentPages.timeline = Math.max(0, Math.min(currentPages.timeline + direction, totalPages - 1));\n            renderTimelineChart();\n        }\n\n        function jumpToTimelinePage() {\n            const input = document.getElementById('timelinePageInput');\n            const page = parseInt(input.value) - 1;\n            const totalPages = Math.ceil(fullData.timeline.labels.length / ITEMS_PER_PAGE);\n            \n            if (page >= 0 && page < totalPages) {\n                currentPages.timeline = page;\n                renderTimelineChart();\n            } else {\n                input.value = currentPages.timeline + 1;\n            }\n        }\n\n        function changeHospitalPage(direction) {\n            const totalPages = Math.ceil(fullData.hospital.labels.length / ITEMS_PER_PAGE);\n            currentPages.hospital = Math.max(0, Math.min(currentPages.hospital + direction, totalPages - 1));\n            renderHospitalChart();\n        }\n\n        function jumpToHospitalPage() {\n            const input = document.getElementById('hospitalPageInput');\n            const page = parseInt(input.value) - 1;\n            const totalPages = Math.ceil(fullData.hospital.labels.length / ITEMS_PER_PAGE);\n            \n            if (page >= 0 && page < totalPages) {\n                currentPages.hospital = page;\n                renderHospitalChart();\n            } else {\n                input.value = currentPages.hospital + 1;\n            }\n        }\n\n        function changeStatePage(direction) {\n            const totalPages = Math.ceil(fullData.state.labels.length / ITEMS_PER_PAGE);\n            currentPages.state = Math.max(0, Math.min(currentPages.state + direction, totalPages - 1));\n            renderStateChart();\n        }\n\n        function jumpToStatePage() {\n            const input = document.getElementById('statePageInput');\n            const page = parseInt(input.value) - 1;\n            const totalPages = Math.ceil(fullData.state.labels.length / ITEMS_PER_PAGE);\n            \n            if (page >= 0 && page < totalPages) {\n                currentPages.state = page;\n                renderStateChart();\n            } else {\n                input.value = currentPages.state + 1;\n            }\n        }\n\n        function changeRobotPage(direction) {\n            const totalPages = Math.ceil(fullData.robot.labels.length / ITEMS_PER_PAGE);\n            currentPages.robot = Math.max(0, Math.min(currentPages.robot + direction, totalPages - 1));\n            renderRobotChart();\n        }\n\n        function jumpToRobotPage() {\n            const input = document.getElementById('robotPageInput');\n            const page = parseInt(input.value) - 1;\n            const totalPages = Math.ceil(fullData.robot.labels.length / ITEMS_PER_PAGE);\n            \n            if (page >= 0 && page < totalPages) {\n                currentPages.robot = page;\n                renderRobotChart();\n            } else {\n                input.value = currentPages.robot + 1;\n            }\n        }\n\n        function renderCharts() {\n            Object.values(charts).forEach(chart => {\n                if (chart && typeof chart.destroy === 'function') {\n                    chart.destroy();\n                }\n            });\n            charts = {};\n            \n            currentPages = { timeline: 0, hospital: 0, state: 0, robot: 0 };\n            \n            if (dashboardData.timeline_data) {\n                fullData.timeline = {\n                    labels: [...(dashboardData.timeline_data.labels || [])],\n                    data: [...(dashboardData.timeline_data.data || [])]\n                };\n            }\n            if (dashboardData.hospital_data) {\n                fullData.hospital = {\n                    labels: [...(dashboardData.hospital_data.labels || [])],\n                    data: [...(dashboardData.hospital_data.data || [])]\n                };\n            }\n            if (dashboardData.state_distribution) {\n                fullData.state = {\n                    labels: [...(dashboardData.state_distribution.labels || [])],\n                    data: [...(dashboardData.state_distribution.data || [])]\n                };\n            }\n            if (dashboardData.robot_data) {\n                fullData.robot = {\n                    labels: [...(dashboardData.robot_data.labels || [])],\n                    data: [...(dashboardData.robot_data.data || [])]\n                };\n            }\n            \n            renderStatusChart();\n            renderIssueTypeChart();\n            renderTimelineChart();\n            renderHospitalChart();\n            renderStateChart();\n            renderPriorityChart();\n            renderRobotChart();\n        }\n\n        function renderStatusChart() {\n            if (dashboardData.status_distribution && dashboardData.status_distribution.labels.length > 0) {\n                charts.status = new Chart(document.getElementById('statusChart'), {\n                    type: 'doughnut',\n                    data: {\n                        labels: dashboardData.status_distribution.labels,\n                        datasets: [{\n                            data: dashboardData.status_distribution.data,\n                            backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#6c757d', '#17a2b8'],\n                            borderWidth: 2,\n                            borderColor: '#fff'\n                        }]\n                    },\n                    options: {\n                        responsive: true,\n                        maintainAspectRatio: false,\n                        plugins: {\n                            legend: { position: 'bottom', labels: { padding: 15, font: { size: 12 } } }\n                        },\n                        onClick: (event, elements) => {\n                            if (elements.length > 0) {\n                                const index = elements[0].index;\n                                const status = dashboardData.status_distribution.labels[index];\n                                navigateToDoctypeWithFilters('ticket-master', { workflow_state: status });\n                            }\n                        }\n                    }\n                });\n            }\n        }\n\n        function renderIssueTypeChart() {\n            if (dashboardData.issue_type_distribution && dashboardData.issue_type_distribution.labels.length > 0) {\n                charts.issueType = new Chart(document.getElementById('issueTypeChart'), {\n                    type: 'pie',\n                    data: {\n                        labels: dashboardData.issue_type_distribution.labels,\n                        datasets: [{\n                            data: dashboardData.issue_type_distribution.data,\n                            backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe'],\n                            borderWidth: 2,\n                            borderColor: '#fff'\n                        }]\n                    },\n                    options: {\n                        responsive: true,\n                        maintainAspectRatio: false,\n                        plugins: {\n                            legend: { position: 'bottom', labels: { padding: 15, font: { size: 12 } } }\n                        },\n                        onClick: (event, elements) => {\n                            if (elements.length > 0) {\n                                const index = elements[0].index;\n                                const issueType = dashboardData.issue_type_distribution.labels[index];\n                                navigateToDoctypeWithFilters('ticket-master', { issue_type: issueType });\n                            }\n                        }\n                    }\n                });\n            }\n        }\n\n        function renderTimelineChart() {\n            if (fullData.timeline.labels.length > 0) {\n                const totalPages = Math.ceil(fullData.timeline.labels.length / ITEMS_PER_PAGE);\n                const paginatedData = getPaginatedData(\n                    fullData.timeline.labels,\n                    fullData.timeline.data,\n                    currentPages.timeline,\n                    ITEMS_PER_PAGE\n                );\n                \n                if (charts.timeline) charts.timeline.destroy();\n                \n                charts.timeline = new Chart(document.getElementById('timelineChart'), {\n                    type: 'line',\n                    data: {\n                        labels: paginatedData.labels,\n                        datasets: [{\n                            label: 'Tickets Created',\n                            data: paginatedData.data,\n                            borderColor: '#667eea',\n                            backgroundColor: 'rgba(102, 126, 234, 0.1)',\n                            tension: 0.4,\n                            fill: true\n                        }]\n                    },\n                    options: {\n                        responsive: true,\n                        maintainAspectRatio: false,\n                        plugins: {\n                            legend: { display: false }\n                        },\n                        scales: {\n                            y: { beginAtZero: true }\n                        },\n                        onClick: (event, elements) => {\n                            if (elements.length > 0) {\n                                const index = elements[0].index;\n                                const date = paginatedData.labels[index];\n                                navigateToDoctypeWithFilters('ticket-master', { creation: date });\n                            }\n                        }\n                    }\n                });\n                \n                updatePaginationControls('timeline', currentPages.timeline, totalPages);\n            }\n        }\n\n        function renderHospitalChart() {\n            if (fullData.hospital.labels.length > 0) {\n                const dataLength = fullData.hospital.labels.length;\n                const useScroll = dataLength > SCROLL_THRESHOLD;\n                \n                if (useScroll) {\n                    renderHospitalChartWithScroll();\n                } else {\n                    renderHospitalChartWithPagination();\n                }\n            }\n        }\n\n        function renderHospitalChartWithScroll() {\n            if (charts.hospital) charts.hospital.destroy();\n            \n            const hospitalCanvas = document.getElementById('hospitalChart');\n            const itemHeight = 30;\n            const calculatedHeight = Math.max(300, fullData.hospital.labels.length * itemHeight);\n            hospitalCanvas.height = calculatedHeight;\n            \n            charts.hospital = new Chart(hospitalCanvas, {\n                type: 'bar',\n                data: {\n                    labels: fullData.hospital.labels,\n                    datasets: [{\n                        label: 'Number of Tickets',\n                        data: fullData.hospital.data,\n                        backgroundColor: '#667eea',\n                        borderRadius: 8\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    indexAxis: 'y',\n                    plugins: {\n                        legend: { display: false }\n                    },\n                    scales: {\n                        x: { beginAtZero: true }\n                    },\n                    onClick: (event, elements) => {\n                        if (elements.length > 0) {\n                            const index = elements[0].index;\n                            const hospital = fullData.hospital.labels[index];\n                            navigateToDoctypeWithFilters('ticket-master', { hospital_name: hospital });\n                        }\n                    }\n                }\n            });\n            \n            document.getElementById('hospitalPagination').style.display = 'none';\n        }\n\n        function renderHospitalChartWithPagination() {\n            const totalPages = Math.ceil(fullData.hospital.labels.length / ITEMS_PER_PAGE);\n            const paginatedData = getPaginatedData(\n                fullData.hospital.labels,\n                fullData.hospital.data,\n                currentPages.hospital,\n                ITEMS_PER_PAGE\n            );\n            \n            if (charts.hospital) charts.hospital.destroy();\n            \n            const hospitalCanvas = document.getElementById('hospitalChart');\n            hospitalCanvas.height = 300;\n            \n            charts.hospital = new Chart(hospitalCanvas, {\n                type: 'bar',\n                data: {\n                    labels: paginatedData.labels,\n                    datasets: [{\n                        label: 'Number of Tickets',\n                        data: paginatedData.data,\n                        backgroundColor: '#667eea',\n                        borderRadius: 8\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    indexAxis: 'y',\n                    plugins: {\n                        legend: { display: false }\n                    },\n                    scales: {\n                        x: { beginAtZero: true }\n                    },\n                    onClick: (event, elements) => {\n                        if (elements.length > 0) {\n                            const index = elements[0].index;\n                            const hospital = paginatedData.labels[index];\n                            navigateToDoctypeWithFilters('ticket-master', { hospital_name: hospital });\n                        }\n                    }\n                }\n            });\n            \n            updatePaginationControls('hospital', currentPages.hospital, totalPages);\n        }\n\n        function renderStateChart() {\n            if (fullData.state.labels.length > 0) {\n                const dataLength = fullData.state.labels.length;\n                const useScroll = dataLength > SCROLL_THRESHOLD;\n                \n                if (useScroll) {\n                    renderStateChartWithScroll();\n                } else {\n                    renderStateChartWithPagination();\n                }\n            }\n        }\n\n        function renderStateChartWithScroll() {\n            if (charts.state) charts.state.destroy();\n            \n            const stateCanvas = document.getElementById('stateChart');\n            const itemHeight = 30;\n            const calculatedHeight = Math.max(300, fullData.state.labels.length * itemHeight);\n            stateCanvas.height = calculatedHeight;\n            \n            charts.state = new Chart(stateCanvas, {\n                type: 'bar',\n                data: {\n                    labels: fullData.state.labels,\n                    datasets: [{\n                        label: 'Tickets by State',\n                        data: fullData.state.data,\n                        backgroundColor: '#764ba2',\n                        borderRadius: 8\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    indexAxis: 'y',\n                    plugins: {\n                        legend: { display: false }\n                    },\n                    scales: {\n                        x: { beginAtZero: true }\n                    },\n                    onClick: (event, elements) => {\n                        if (elements.length > 0) {\n                            const index = elements[0].index;\n                            const state = fullData.state.labels[index];\n                            navigateToDoctypeWithFilters('ticket-master', { state: state });\n                        }\n                    }\n                }\n            });\n            \n            document.getElementById('statePagination').style.display = 'none';\n        }\n\n        function renderStateChartWithPagination() {\n            const totalPages = Math.ceil(fullData.state.labels.length / ITEMS_PER_PAGE);\n            const paginatedData = getPaginatedData(\n                fullData.state.labels,\n                fullData.state.data,\n                currentPages.state,\n                ITEMS_PER_PAGE\n            );\n            \n            if (charts.state) charts.state.destroy();\n            \n            const stateCanvas = document.getElementById('stateChart');\n            stateCanvas.height = 300;\n            \n            charts.state = new Chart(stateCanvas, {\n                type: 'bar',\n                data: {\n                    labels: paginatedData.labels,\n                    datasets: [{\n                        label: 'Tickets by State',\n                        data: paginatedData.data,\n                        backgroundColor: '#764ba2',\n                        borderRadius: 8\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    indexAxis: 'y',\n                    plugins: {\n                        legend: { display: false }\n                    },\n                    scales: {\n                        x: { beginAtZero: true }\n                    },\n                    onClick: (event, elements) => {\n                        if (elements.length > 0) {\n                            const index = elements[0].index;\n                            const state = paginatedData.labels[index];\n                            navigateToDoctypeWithFilters('ticket-master', { state: state });\n                        }\n                    }\n                }\n            });\n            \n            updatePaginationControls('state', currentPages.state, totalPages);\n        }\n\n        function renderPriorityChart() {\n            if (dashboardData.priority_distribution && dashboardData.priority_distribution.labels.length > 0) {\n                charts.priority = new Chart(document.getElementById('priorityChart'), {\n                    type: 'doughnut',\n                    data: {\n                        labels: dashboardData.priority_distribution.labels,\n                        datasets: [{\n                            data: dashboardData.priority_distribution.data,\n                            backgroundColor: ['#dc3545', '#ffc107', '#28a745'],\n                            borderWidth: 2,\n                            borderColor: '#fff'\n                        }]\n                    },\n                    options: {\n                        responsive: true,\n                        maintainAspectRatio: false,\n                        plugins: {\n                            legend: { position: 'bottom', labels: { padding: 15, font: { size: 12 } } }\n                        },\n                        onClick: (event, elements) => {\n                            if (elements.length > 0) {\n                                const index = elements[0].index;\n                                const priority = dashboardData.priority_distribution.labels[index];\n                                navigateToDoctypeWithFilters('ticket-master', { priorty: priority });\n                            }\n                        }\n                    }\n                });\n            }\n        }\n\n        function renderRobotChart() {\n            if (fullData.robot.labels.length > 0) {\n                const dataLength = fullData.robot.labels.length;\n                const useScroll = dataLength > SCROLL_THRESHOLD;\n                \n                if (useScroll) {\n                    renderRobotChartWithScroll();\n                } else {\n                    renderRobotChartWithPagination();\n                }\n            }\n        }\n\n        function renderRobotChartWithScroll() {\n            if (charts.robot) charts.robot.destroy();\n            \n            const robotCanvas = document.getElementById('robotChart');\n            const itemHeight = 30;\n            const calculatedHeight = Math.max(300, fullData.robot.labels.length * itemHeight);\n            robotCanvas.height = calculatedHeight;\n            \n            charts.robot = new Chart(robotCanvas, {\n                type: 'bar',\n                data: {\n                    labels: fullData.robot.labels,\n                    datasets: [{\n                        label: 'Issue Count',\n                        data: fullData.robot.data,\n                        backgroundColor: '#4facfe',\n                        borderRadius: 8\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    indexAxis: 'y',\n                    plugins: {\n                        legend: { display: false }\n                    },\n                    scales: {\n                        x: { beginAtZero: true }\n                    },\n                    onClick: (event, elements) => {\n                        if (elements.length > 0) {\n                            const index = elements[0].index;\n                            const robot = fullData.robot.labels[index];\n                            navigateToDoctypeWithFilters('ticket-master', { robot_serial_no: robot });\n                        }\n                    }\n                }\n            });\n            \n            document.getElementById('robotPagination').style.display = 'none';\n        }\n\n        function renderRobotChartWithPagination() {\n            const totalPages = Math.ceil(fullData.robot.labels.length / ITEMS_PER_PAGE);\n            const paginatedData = getPaginatedData(\n                fullData.robot.labels,\n                fullData.robot.data,\n                currentPages.robot,\n                ITEMS_PER_PAGE\n            );\n            \n            if (charts.robot) charts.robot.destroy();\n            \n            const robotCanvas = document.getElementById('robotChart');\n            robotCanvas.height = 300;\n            \n            charts.robot = new Chart(robotCanvas, {\n                type: 'bar',\n                data: {\n                    labels: paginatedData.labels,\n                    datasets: [{\n                        label: 'Issue Count',\n                        data: paginatedData.data,\n                        backgroundColor: '#4facfe',\n                        borderRadius: 8\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    indexAxis: 'y',\n                    plugins: {\n                        legend: { display: false }\n                    },\n                    scales: {\n                        x: { beginAtZero: true }\n                    },\n                    onClick: (event, elements) => {\n                        if (elements.length > 0) {\n                            const index = elements[0].index;\n                            const robot = paginatedData.labels[index];\n                            navigateToDoctypeWithFilters('ticket-master', { robot_serial_no: robot });\n                        }\n                    }\n                }\n            });\n            \n            updatePaginationControls('robot', currentPages.robot, totalPages);\n        }\n\n        function populateTable() {\n            const tbody = document.getElementById('ticketTable');\n            const tickets = dashboardData.recent_tickets;\n            \n            if (!tickets || tickets.length === 0) {\n                tbody.innerHTML = '<tr><td colspan=\"11\" style=\"text-align: center; padding: 30px;\">No tickets found for the selected filters</td></tr>';\n                return;\n            }\n            \n            tbody.innerHTML = tickets.map(ticket => {\n                const statusClass = getStatusClass(ticket.workflow_state);\n                const ticketUrl = `/app/ticket-master/${ticket.name}`;\n                \n                return `\n                    <tr>\n                        <td><a href=\"${ticketUrl}\" class=\"ticket-link\">${ticket.name}</a></td>\n                        <td><span class=\"status-badge ${statusClass}\">${ticket.workflow_state || 'N/A'}</span></td>\n                        <td>${ticket.state || '-'}</td>\n                        <td>${ticket.robot_serial_no || '-'}</td>\n                        <td>${ticket.ticket_subject || '-'}</td>\n                        <td>${ticket.hospital_name || '-'}</td>\n                        <td>${ticket.issue_type || '-'}</td>\n                        <td>${ticket.priorty || '-'}</td>\n                        <td>${ticket.engineers || '-'}</td>\n                        <td>${ticket.days_open}d</td>\n                        <td>${formatDate(ticket.creation)}</td>\n                    </tr>\n                `;\n            }).join('');\n        }\n\n        function getStatusClass(status) {\n            if (!status) return 'status-open';\n            const statusLower = status.toLowerCase();\n            if (statusLower.includes('resolved')) return 'status-resolved';\n            if (statusLower.includes('pending')) return 'status-pending';\n            if (statusLower.includes('closed')) return 'status-closed';\n            return 'status-open';\n        }\n\n        function formatDate(dateStr) {\n            if (!dateStr) return '-';\n            const date = new Date(dateStr);\n            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});\n        }\n\n        function updateTimestamp() {\n            document.getElementById('lastUpdate').textContent = new Date().toLocaleString();\n        }\n\n        function applyFilters() {\n            const fromDate = document.getElementById('fromDate').value;\n            const toDate = document.getElementById('toDate').value;\n            \n            if (!fromDate || !toDate) {\n                showError('Please select both From Date and To Date before applying filters.');\n                return;\n            }\n            \n            loadFilterOptions().then(() => {\n                loadDashboardData();\n                // Collapse the filter section after applying\n                setTimeout(() => {\n                    const filterSection = document.getElementById('filterSection');\n                    if (filterSection && !filterSection.classList.contains('collapsed')) {\n                        filterSection.classList.add('collapsed');\n                    }\n                }, 500);\n            });\n        }\n\n        function clearFilters() {\n            document.getElementById('fromDate').value = '';\n            document.getElementById('toDate').value = '';\n            document.getElementById('stateFilter').value = '';\n            document.getElementById('hospitalFilter').value = '';\n            document.getElementById('robotFilter').value = '';\n            document.getElementById('statusFilter').value = '';\n            document.getElementById('priorityFilter').value = '';\n            document.getElementById('issueTypeFilter').value = '';\n            \n            const selects = ['stateFilter', 'hospitalFilter', 'robotFilter', 'statusFilter', 'priorityFilter', 'issueTypeFilter'];\n            selects.forEach(id => {\n                const select = document.getElementById(id);\n                while (select.options.length > 1) {\n                    select.remove(1);\n                }\n            });\n            \n            document.getElementById('dashboardContent').style.display = 'none';\n            const initialMsg = document.getElementById('initialMessage');\n            if (initialMsg) {\n                initialMsg.style.display = 'block';\n            }\n            \n            // Expand the filter section\n            const filterSection = document.getElementById('filterSection');\n            if (filterSection && filterSection.classList.contains('collapsed')) {\n                filterSection.classList.remove('collapsed');\n            }\n            \n            hideError();\n        }\n\n        function refreshData() {\n            const fromDate = document.getElementById('fromDate').value;\n            const toDate = document.getElementById('toDate').value;\n            \n            if (!fromDate || !toDate) {\n                showError('Please select both From Date and To Date before refreshing.');\n                return;\n            }\n            \n            loadDashboardData();\n        }\n\n        function exportToCSV() {\n            if (!dashboardData || !dashboardData.recent_tickets) {\n                showError('No data available to export');\n                return;\n            }\n            \n            const tickets = dashboardData.recent_tickets;\n            const headers = ['Ticket ID', 'Status', 'State', 'Robot Serial No', 'Subject', 'Hospital', 'Issue Type', 'Priority', 'Engineers', 'Days Open', 'Created On'];\n            \n            const csvContent = [\n                headers.join(','),\n                ...tickets.map(t => [\n                    t.name,\n                    t.workflow_state || '',\n                    t.state || '',\n                    t.robot_serial_no || '',\n                    `\"${(t.ticket_subject || '').replace(/\"/g, '\"\"')}\"`,\n                    t.hospital_name || '',\n                    t.issue_type || '',\n                    t.priorty || '',\n                    `\"${(t.engineers || '').replace(/\"/g, '\"\"')}\"`,\n                    t.days_open,\n                    t.creation || ''\n                ].join(','))\n            ].join('\\n');\n\n            const blob = new Blob([csvContent], { type: 'text/csv' });\n            const url = window.URL.createObjectURL(blob);\n            const a = document.createElement('a');\n            a.href = url;\n            a.download = `ticket_master_export_${new Date().toISOString().split('T')[0]}.csv`;\n            a.click();\n            window.URL.revokeObjectURL(url);\n        }\n\n        function showLoading(show) {\n            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';\n        }\n\n        function showError(message) {\n            const errorContainer = document.getElementById('errorContainer');\n            errorContainer.innerHTML = `<div class=\"error-message\">${message}</div>`;\n        }\n\n        function hideError() {\n            document.getElementById('errorContainer').innerHTML = '';\n        }\n\n        // CRITICAL FIX: Clear existing filters and apply fresh filters\n        function navigateToDoctypeWithFilters(doctype, additionalFilters = {}) {\n            const fromDate = document.getElementById('fromDate').value;\n            const toDate = document.getElementById('toDate').value;\n            const state = document.getElementById('stateFilter').value;\n            const hospital = document.getElementById('hospitalFilter').value;\n            const robot = document.getElementById('robotFilter').value;\n            const status = document.getElementById('statusFilter').value;\n            const priority = document.getElementById('priorityFilter').value;\n            const issueType = document.getElementById('issueTypeFilter').value;\n            \n            // Build fresh filter array - NO accumulation of old filters\n            let filters = [];\n            \n            // Add date range filter\n            if (fromDate && toDate) {\n                filters.push(['Ticket Master', 'creation', 'Between', [fromDate + ' 00:00:00', toDate + ' 23:59:59']]);\n            }\n            \n            // Add dashboard filters (only if they exist)\n            if (state) {\n                filters.push(['Ticket Master', 'state', '=', state]);\n            }\n            if (hospital) {\n                filters.push(['Ticket Master', 'hospital_name', '=', hospital]);\n            }\n            if (robot) {\n                filters.push(['Ticket Master', 'robot_serial_no', '=', robot]);\n            }\n            if (status) {\n                filters.push(['Ticket Master', 'workflow_state', '=', status]);\n            }\n            if (priority) {\n                filters.push(['Ticket Master', 'priorty', '=', priority]);\n            }\n            if (issueType) {\n                filters.push(['Ticket Master', 'issue_type', '=', issueType]);\n            }\n            \n            // Add additional filters from card clicks\n            Object.entries(additionalFilters).forEach(([key, value]) => {\n                if (value) {\n                    if (key.endsWith('_not')) {\n                        const actualKey = key.replace('_not', '');\n                        filters.push(['Ticket Master', actualKey, '!=', value]);\n                    } else {\n                        // Remove any existing filter for this key first\n                        filters = filters.filter(f => f[1] !== key);\n                        filters.push(['Ticket Master', key, '=', value]);\n                    }\n                }\n            });\n            \n            console.log('Fresh filters to apply:', filters);\n            \n            // Clear any existing stored filters\n            try {\n                sessionStorage.removeItem('pending_list_filters');\n                localStorage.removeItem('pending_list_filters');\n            } catch (e) {\n                console.error('Failed to clear old filters:', e);\n            }\n            \n            // Store new filters\n            try {\n                sessionStorage.setItem('pending_list_filters', JSON.stringify(filters));\n                console.log('Fresh filters stored in sessionStorage');\n            } catch (e) {\n                console.error('Failed to store filters:', e);\n            }\n            \n            // Open the list view\n            const listWindow = window.open('/app/ticket-master', '_blank');\n            \n            // Send filters to the new window\n            setTimeout(() => {\n                try {\n                    if (listWindow && !listWindow.closed) {\n                        // Send clear command first\n                        listWindow.postMessage({\n                            type: 'clear_all_filters'\n                        }, window.location.origin);\n                        \n                        // Then send new filters\n                        setTimeout(() => {\n                            listWindow.postMessage({\n                                type: 'apply_dashboard_filters',\n                                filters: filters,\n                                clearExisting: true\n                            }, window.location.origin);\n                            console.log('Sent fresh filters to new window');\n                        }, 100);\n                    }\n                } catch (e) {\n                    console.error('Could not send message to new window:', e);\n                }\n            }, 2000);\n        }\n\n        // Auto-refresh every 5 minutes\n        setInterval(() => {\n            const fromDate = document.getElementById('fromDate').value;\n            const toDate = document.getElementById('toDate').value;\n            \n            if (fromDate && toDate && document.getElementById('dashboardContent').style.display !== 'none') {\n                console.log('Auto-refreshing dashboard data...');\n                refreshData();\n            }\n        }, 300000);\n\n        // Listen for messages from parent window\n        window.addEventListener('message', function(event) {\n            if (event.data && event.data.type === 'apply_filters') {\n                console.log('Received filter message:', event.data.filters);\n                if (typeof frappe !== 'undefined' && frappe.set_route) {\n                    frappe.set_route('List', 'Ticket Master', event.data.filters);\n                }\n            }\n        });\n    </script>\n</body>\n</html>",
  "main_section_md": null,
  "meta_description": null,
  "meta_image": null,
  "meta_title": null,
  "modified": "2026-01-29 11:11:49.695042",
  "module": "Merai Newage",
  "name": "ticket-mangement",
  "page_blocks": [],
  "published": 1,
  "route": "ticket-dashboard",
  "show_sidebar": 0,
  "show_title": 0,
  "slideshow": null,
  "start_date": null,
  "text_align": "Left",
  "title": "Ticket Mangement",
  "website_sidebar": null
 }
]